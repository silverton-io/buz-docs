"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[3099],{3905:(e,t,a)=>{a.d(t,{Zo:()=>u,kt:()=>g});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var l=n.createContext({}),c=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},u=function(e){var t=c(e.components);return n.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),d=c(a),g=r,m=d["".concat(l,".").concat(g)]||d[g]||p[g]||i;return a?n.createElement(m,o(o({ref:t},u),{},{components:a})):n.createElement(m,o({ref:t},u))}));function g(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=a.length,o=new Array(i);o[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var c=2;c<i;c++)o[c]=a[c];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},4800:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>p,frontMatter:()=>i,metadata:()=>s,toc:()=>c});var n=a(7462),r=(a(7294),a(3905));const i={sidebar_position:1,title:"Cloud Run",description:"Deploy Buz, the open-source serverless event tracking system, to Cloud Run in 3 minutes using Terraform."},o=void 0,s={unversionedId:"deploying/gcp/cloud_run",id:"deploying/gcp/cloud_run",title:"Cloud Run",description:"Deploy Buz, the open-source serverless event tracking system, to Cloud Run in 3 minutes using Terraform.",source:"@site/docs/deploying/gcp/cloud_run.md",sourceDirName:"deploying/gcp",slug:"/deploying/gcp/cloud_run",permalink:"/deploying/gcp/cloud_run",draft:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1,title:"Cloud Run",description:"Deploy Buz, the open-source serverless event tracking system, to Cloud Run in 3 minutes using Terraform."},sidebar:"defaultSidebar",previous:{title:"Overview",permalink:"/deploying/overview"},next:{title:"Lambda",permalink:"/deploying/aws/lambda"}},l={},c=[{value:"Overview",id:"overview",level:2},{value:"Primary Resources",id:"primary-resources",level:2},{value:"Console Deploy",id:"console-deploy",level:2},{value:"1. Create Pub/Sub topics.",id:"1-create-pubsub-topics",level:3},{value:"2. Upload config to Secret Manager.",id:"2-upload-config-to-secret-manager",level:3},{value:"3. Push image to GCP Artifact Registry.",id:"3-push-image-to-gcp-artifact-registry",level:3},{value:"4. Run Buz as a Cloud Run service.",id:"4-run-buz-as-a-cloud-run-service",level:3},{value:"Bonus",id:"bonus",level:3},{value:"Map a custom domain to Buz",id:"map-a-custom-domain-to-buz",level:4},{value:"Set up a GCS schema registry backend",id:"set-up-a-gcs-schema-registry-backend",level:4},{value:"Push events to BigQuery using a Pub/Sub Subscription",id:"push-events-to-bigquery-using-a-pubsub-subscription",level:4},{value:"Terraform",id:"terraform",level:2}],u={toc:c};function p(e){let{components:t,...i}=e;return(0,r.kt)("wrapper",(0,n.Z)({},u,i,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"deploy",src:a(7980).Z,width:"1358",height:"805"})),(0,r.kt)("h2",{id:"overview"},"Overview"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://cloud.google.com/run/docs/overview/what-is-cloud-run"},"GCP Cloud Run")," is an managed way to run containers. Here we are deploying the Buz image to GCP Artifact Registry. The schemas are maintained in GCP bucket and the Buz Configurations are maintained as a GCP Secret. Data processed by buz are sent to one of two Pub/Subs."),(0,r.kt)("h2",{id:"primary-resources"},"Primary Resources"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Buz (Cloud Run)"),(0,r.kt)("li",{parentName:"ul"},"Artifact Registry"),(0,r.kt)("li",{parentName:"ul"},"Secret"),(0,r.kt)("li",{parentName:"ul"},"Bucket"),(0,r.kt)("li",{parentName:"ul"},"2 Pub/Sub")),(0,r.kt)("h2",{id:"console-deploy"},"Console Deploy"),(0,r.kt)("p",null,"Here are the steps to set up Buz via the GCP Console."),(0,r.kt)("h3",{id:"1-create-pubsub-topics"},"1. Create ",(0,r.kt)("a",{parentName:"h3",href:"https://console.cloud.google.com/cloudpubsub/"},"Pub/Sub")," topics."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Create ",(0,r.kt)("inlineCode",{parentName:"strong"},"buz-valid")," and ",(0,r.kt)("inlineCode",{parentName:"strong"},"buz-invalid")," Pub/Sub topics:")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"create topic",src:a(6808).Z,width:"2546",height:"1228"})),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"configure topic",src:a(6455).Z,width:"2710",height:"1544"})),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"The result should look like:")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"desired result",src:a(7595).Z,width:"3098",height:"1134"})),(0,r.kt)("admonition",{title:"Yo",type:"info"},(0,r.kt)("p",{parentName:"admonition"},'It is entirely possible to only use one output topic but if you want the upside of redirecting events that fail validation out of the "happy path", two topics are necessary.')),(0,r.kt)("h3",{id:"2-upload-config-to-secret-manager"},"2. Upload config to ",(0,r.kt)("a",{parentName:"h3",href:"https://console.cloud.google.com/security/secret-manager"},"Secret Manager"),"."),(0,r.kt)("p",null,"For the sake of keeping your secrets a.. secret.. uploading the entire Buz config yml to Secret Manager is the easiest way forward."),(0,r.kt)("admonition",{title:"YO",type:"info"},(0,r.kt)("p",{parentName:"admonition"},"We've provided a working config sample that you can ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/silverton-io/buz-docs/blob/main/examples/deploy/gcp/config.yml"},"copy/paste to Secret Manager here"),".")),(0,r.kt)("p",null,"Create Buz config as a Secret Manager secret"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"create secret",src:a(1862).Z,width:"2980",height:"1334"})),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"configure secret",src:a(4223).Z,width:"1680",height:"1634"})),(0,r.kt)("p",null,"If all is well you'll see:"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"desired secret",src:a(6691).Z,width:"2660",height:"1134"})),(0,r.kt)("p",null,"Grant the default compute service account ",(0,r.kt)("a",{parentName:"p",href:"https://console.cloud.google.com/iam-admin/iam"},"appropriate iam access"),". It will need the ",(0,r.kt)("inlineCode",{parentName:"p"},"Secret Manager Secret Accessor")," role:"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"grant secret accessor",src:a(5155).Z,width:"1704",height:"952"})),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"configure secret accessor",src:a(9981).Z,width:"2310",height:"1346"})),(0,r.kt)("admonition",{title:"Yo",type:"caution"},(0,r.kt)("ul",{parentName:"admonition"},(0,r.kt)("li",{parentName:"ul"},"While this example uses the ",(0,r.kt)("inlineCode",{parentName:"li"},"default compute service account")," you'll probably want to create a dedicated service user."))),(0,r.kt)("h3",{id:"3-push-image-to-gcp-artifact-registry"},"3. Push image to GCP ",(0,r.kt)("a",{parentName:"h3",href:"https://console.cloud.google.com/artifacts"},"Artifact Registry"),"."),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://console.cloud.google.com/artifacts/create-repo"},"Create a Docker repository")," in GCP Artifact Registry if you don't have one yet:"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"create registry",src:a(2931).Z,width:"3380",height:"1650"})),(0,r.kt)("p",null,"Auth to newly-created registry"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"gcloud auth configure-docker us-east1-docker.pkg.dev\nAdding credentials for: us-east1-docker.pkg.dev\n....\nDocker configuration file updated.\n")),(0,r.kt)("p",null,"Pull the latest Buz image from the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/silverton-io/buz/pkgs/container/buz"},"Github container registry"),":"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"docker pull ghcr.io/silverton-io/buz:v0.11.11 --platform linux/amd64")),(0,r.kt)("admonition",{title:"AMD64",type:"warning"},(0,r.kt)("ul",{parentName:"admonition"},(0,r.kt)("li",{parentName:"ul"},"At the time of writing Google Cloud Run doesn't support ARM64-based images so you'll need to grab the AMD64 image."))),(0,r.kt)("p",null,"Tag and push the latest Buz image to Artifact Registry:"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Tag:")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"docker tag ghcr.io/silverton-io/buz:v0.11.11 us-east1-docker.pkg.dev/silverton-docs/registry/buz:v0.11.11")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Push:")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"docker push us-east1-docker.pkg.dev/silverton-docs/registry/buz:v0.11.11")),(0,r.kt)("admonition",{title:"Use your own Artifact Registry URL",type:"warning"},(0,r.kt)("p",{parentName:"admonition"},"This example uses the Silverton registry url - you'll need to use your own."),(0,r.kt)("p",{parentName:"admonition"},"It's structured as: ",(0,r.kt)("inlineCode",{parentName:"p"},"$ARTIFACT_REGISTRY_URL/$GCP_PROJECT/$REGISTRY_NAME/buz:$VERSION"))),(0,r.kt)("hr",null),(0,r.kt)("h3",{id:"4-run-buz-as-a-cloud-run-service"},"4. Run Buz as a ",(0,r.kt)("a",{parentName:"h3",href:"https://console.cloud.google.com/run"},"Cloud Run")," service."),(0,r.kt)("p",null,"Create a new ",(0,r.kt)("inlineCode",{parentName:"p"},"Buz")," service:"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"create service",src:a(4586).Z,width:"3384",height:"1662"})),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"configure service 1",src:a(4688).Z,width:"2450",height:"1658"})),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"configure service 2",src:a(9147).Z,width:"2442",height:"1648"})),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"configure service 3",src:a(8587).Z,width:"2442",height:"1576"})),(0,r.kt)("p",null,"Verify service is running (using out-of-the-box metrics and logs):"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"verify service",src:a(1510).Z,width:"2742",height:"1542"})),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"service metrics",src:a(5512).Z,width:"2748",height:"1670"})),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"service logs",src:a(9677).Z,width:"2734",height:"1662"})),(0,r.kt)("admonition",{title:"Yo",type:"caution"},(0,r.kt)("ul",{parentName:"admonition"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Log verbosity is cranked in the example configuration.")," You'll probably want less."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"The stdout sink is included for feedback purposes.")," You'll probably want to turn it off."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"The above screenshots are all GCP Cloud Run defaults.")," You'll probably want to tune them."))),(0,r.kt)("h3",{id:"bonus"},"Bonus"),(0,r.kt)("h4",{id:"map-a-custom-domain-to-buz"},"Map a ",(0,r.kt)("a",{parentName:"h4",href:"https://cloud.google.com/run/docs/mapping-custom-domains"},"custom domain")," to Buz"),(0,r.kt)("admonition",{title:"Yo",type:"warning"},(0,r.kt)("p",{parentName:"admonition"},"While this step is ",(0,r.kt)("strong",{parentName:"p"},"technically optional"),", some Buz functionality like server-side identity cookies ",(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("em",{parentName:"strong"},"will not work without it.")))),(0,r.kt)("p",null,"It takes a minute to map a domain/subdomain to a GCP Cloud Run service. Here's how to do it."),(0,r.kt)("p",null,"Add mapping:"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"manage domains",src:a(9895).Z,width:"2754",height:"1020"})),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"add mapping",src:a(2950).Z,width:"3116",height:"1334"})),(0,r.kt)("p",null,"Follow directions to update your dns records:"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"service mapping and dns",src:a(9187).Z,width:"2142",height:"1096"})),(0,r.kt)("h4",{id:"set-up-a-gcs-schema-registry-backend"},"Set up a GCS schema registry backend"),(0,r.kt)("admonition",{title:"Yo",type:"info"},(0,r.kt)("ul",{parentName:"admonition"},(0,r.kt)("li",{parentName:"ul"},"While this step is optional, you'll need to do it when using custom schemas."),(0,r.kt)("li",{parentName:"ul"},"Buz includes an ",(0,r.kt)("a",{parentName:"li",href:"/under-the-hood/registry/overview"},"onboard schema registry")," that supports many cache backends, so you can just as easily use a different backend."))),(0,r.kt)("p",null,"Create a GCS bucket for schemas:"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"create bucket",src:a(6998).Z,width:"3110",height:"1612"})),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"configure bucket",src:a(8851).Z,width:"2696",height:"1400"})),(0,r.kt)("p",null,"Copy schemas to the new schema bucket using ",(0,r.kt)("a",{parentName:"p",href:"https://cloud.google.com/storage/docs/gsutil"},"gsutil"),":"),(0,r.kt)("p",null,"(From ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/silverton-io/buz"},"buz")," root)"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"buz \u276f\u276f\u276f gsutil cp -r schemas/*  gs://$THE_BUCKET_YOU_JUST_CREATED\n")),(0,r.kt)("p",null,"Reconfigure Buz with a new schema registry backend:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"registry:\n  backend:\n    type: gcs\n    bucket: $THE_BUCKET_YOU_JUST_CREATED\n    path: /\n")),(0,r.kt)("hr",null),(0,r.kt)("h4",{id:"push-events-to-bigquery-using-a-pubsub-subscription"},"Push events to ",(0,r.kt)("a",{parentName:"h4",href:"https://cloud.google.com/bigquery"},"BigQuery")," using a Pub/Sub Subscription"),(0,r.kt)("p",null,"With the announcment of ",(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("a",{parentName:"strong",href:"https://cloud.google.com/pubsub/docs/bigquery"},"BigQuery Subscriptions"))," pushing events straight to BigQuery is easier than ever."),(0,r.kt)("h2",{id:"terraform"},"Terraform"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/silverton-io/buz/tree/main/deploy/terraform/gcp"},"Github Terraform")))}p.isMDXComponent=!0},2950:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/add-domain-mapping-fb473a0bc4f645b01e2f687a1f7f5868.png"},8851:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/configure-bucket-ea2a48e94117119d1f54126e4769a1e9.png"},9981:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/configure-secret-accessor-18752b4d77778c6036ad2cc7ff226538.png"},4223:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/configure-secret-3213d53271af055da58fa9710f6135e2.png"},4688:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/configure-service-1-4d13106b29e54a88189c924ddc28200c.png"},9147:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/configure-service-2-db7024a031f41685986958202b7c1ff5.png"},8587:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/configure-service-3-433a444bc4f6400109633d967aa6cf93.png"},6455:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/configure-topic-a718cb8d50fe379906868c01e0190feb.png"},6998:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/create-bucket-af840e377e0819fd0cae7bb051e8311a.png"},2931:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/create-registry-b3c18979a59247e812157ad97cd66d20.png"},1862:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/create-secret-251d61ce21ac9d9d77d54d3a3f43dee2.png"},4586:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/create-service-245e35f93bebfbc6264c6f30b297ccfe.png"},6808:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/create-topic-6573ea1de49ff77983500ece8901fb06.png"},7980:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/deploy-cloud-run-6f47d9848d953803621ca2419ee529a7.png"},9677:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/desired-logs-2936f117f201e2e0b2ea12b8e6976043.png"},5512:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/desired-metrics-b8e7a583a06c9ae3b9d9043bf1f5b938.png"},6691:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/desired-secret-7db5b208ecd3e0a8af289e3a528f9e3a.png"},1510:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/desired-service-7055db5d186379d7bcb1853145a0ffe4.png"},7595:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/desired-topics-f3d493c009790ead305a6f4323462839.png"},5155:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/grant-secret-accessor-36efe4320302cfa4df98008146b7dc17.png"},9895:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/manage-custom-domains-bebc2b9e7268857af51c3e78020322a2.png"},9187:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/service-mapping-and-dns-59abfd07099e7b33fc7a3459bc1eb43b.png"}}]);